// Test: broadcast_to() function
// Demonstrates NumPy-style broadcasting for tensor operations

main {
    print("=== broadcast_to() ãƒ†ã‚¹ãƒˆ ===")
    print("")

    // Test 1: 2D -> 3D broadcast (for attention heads)
    print("ãƒ†ã‚¹ãƒˆ1: [4, 64] -> [4, 8, 64] ã«ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ")
    let seq_len = 4
    let head_dim = 64
    let num_heads = 8
    let x1 = ones([seq_len, head_dim])
    print("  å…¥åŠ›:", shape(x1))

    // ã¾ãšreshapeã—ã¦æ¬¡å…ƒã‚’è¿½åŠ  [4, 64] -> [4, 1, 64]
    let x1_reshaped = reshape(x1, [seq_len, 1, head_dim])
    print("  reshapeå¾Œ:", shape(x1_reshaped))

    // broadcastã§ [4, 1, 64] -> [4, 8, 64]
    let y1 = broadcast_to(x1_reshaped, [seq_len, num_heads, head_dim])
    print("  broadcastå¾Œ:", shape(y1))
    print("  âœ… æˆåŠŸ!")
    print("")

    // Test 2: GQA use case - K/V heads to Q heads
    print("ãƒ†ã‚¹ãƒˆ2: GQAç”¨é€” - KVãƒ˜ãƒƒãƒ‰ [4, 256] ã‚’ Qãƒ˜ãƒƒãƒ‰æ¬¡å…ƒã«æ‹¡å¼µ")
    let kv_heads = 4
    let q_heads = 32
    let group_size = 8  // 32 / 4
    let k = ones([seq_len, kv_heads * head_dim])  // [4, 256]
    print("  å…¥åŠ› K shape:", shape(k))

    // Reshape K to [seq, kv_heads, head_dim]
    let k_reshaped = reshape(k, [seq_len, kv_heads, head_dim])
    print("  K reshaped:", shape(k_reshaped))

    // GQAã®æ­£ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼šå„KVãƒ˜ãƒƒãƒ‰ã‚’è¤‡æ•°ã®Qãƒ˜ãƒƒãƒ‰ã§å…±æœ‰
    // [seq, kv_heads, head_dim] -> [seq, kv_heads, 1, head_dim]
    let k_with_group = reshape(k_reshaped, [seq_len, kv_heads, 1, head_dim])
    print("  K with group dim:", shape(k_with_group))

    // Broadcast: [seq, kv_heads, 1, head_dim] -> [seq, kv_heads, group_size, head_dim]
    let k_broadcasted = broadcast_to(k_with_group, [seq_len, kv_heads, group_size, head_dim])
    print("  K broadcasted:", shape(k_broadcasted))

    // Reshape to final: [seq, kv_heads, group_size, head_dim] -> [seq, q_heads, head_dim]
    let k_final = reshape(k_broadcasted, [seq_len, q_heads, head_dim])
    print("  K final shape:", shape(k_final))
    print("  âœ… GQAå¯¾å¿œæˆåŠŸ!")
    print("")

    print("==================================================")
    print("ğŸ‰ broadcast_to() DSLçµ±åˆå®Œäº†!")
    print("")
    print("ä¸»ãªç”¨é€”:")
    print("  â€¢ Grouped Query Attention (GQA)")
    print("  â€¢ ãƒãƒƒãƒæ¬¡å…ƒã®è¿½åŠ ")
    print("  â€¢ ãƒ˜ãƒƒãƒ‰æ¬¡å…ƒã®æ‹¡å¼µ")
    print("  â€¢ NumPyã‚¹ã‚¿ã‚¤ãƒ«ã®ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ")
}
